#!/bin/bash
# Script d'installation et configuration Asterisk pour FreeIPA LDAP

# Variables de configuration
FREEIPA_SERVER="192.168.200.50"
LDAP_BASE_DN="dc=tp,dc=local"
ASTERISK_BIND_DN="cn=Directory Manager"

echo "======================================"
echo "Installation et configuration Asterisk"
echo "======================================"

echo "[+] Installation d'Asterisk sur Debian/Ubuntu..."

# V√©rifier si on est root
if [ "$EUID" -ne 0 ]; then 
    echo "[-] Ce script doit √™tre ex√©cut√© en tant que root"
    exit 1
fi

# D√©tecter la version de Debian
DEBIAN_VERSION=$(cat /etc/debian_version | cut -d. -f1)
echo "[+] Version Debian d√©tect√©e: $DEBIAN_VERSION"

# Mise √† jour des paquets
echo "[+] Mise √† jour de la liste des paquets..."
apt update

# Ajouter les d√©p√¥ts n√©cessaires pour Asterisk sur Debian 12+
if [ "$DEBIAN_VERSION" -ge "12" ]; then
    echo "[+] Ajout du d√©p√¥t non-free pour Asterisk..."
    # V√©rifier si non-free est d√©j√† dans sources.list
    if ! grep -q "non-free" /etc/apt/sources.list; then
        sed -i 's/main$/main contrib non-free non-free-firmware/' /etc/apt/sources.list
        apt update
    fi
fi

# Installation des paquets Asterisk disponibles
echo "[+] Installation d'Asterisk et des modules..."

# Essayer d'abord les paquets Asterisk standards
if apt-cache show asterisk &>/dev/null; then
    apt install -y asterisk asterisk-modules asterisk-dev asterisk-doc
else
    # Installation depuis les sources ou d√©p√¥t alternatif
    echo "[+] Installation depuis les d√©p√¥ts alternatifs..."
    
    # Ajouter le d√©p√¥t Asterisk officiel
    wget -O - https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-key.gpg | apt-key add - 2>/dev/null || true
    echo "deb https://downloads.asterisk.org/pub/telephony/asterisk bookworm main" > /etc/apt/sources.list.d/asterisk.list 2>/dev/null || true
    
    # Ou installer depuis les sources
    echo "[+] Installation des d√©pendances pour compilation..."
    apt install -y build-essential wget libssl-dev libncurses5-dev libedit-dev libxml2-dev uuid-dev libsqlite3-dev pkg-config
    
    # T√©l√©charger et compiler Asterisk
    cd /tmp
    ASTERISK_VERSION="20.10.0"
    wget -q https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-${ASTERISK_VERSION}.tar.gz
    
    if [ -f "asterisk-${ASTERISK_VERSION}.tar.gz" ]; then
        echo "[+] Compilation d'Asterisk ${ASTERISK_VERSION}..."
        tar xzf asterisk-${ASTERISK_VERSION}.tar.gz
        cd asterisk-${ASTERISK_VERSION}
        
        # Configuration avec support LDAP
        ./configure --with-ldap
        
        # Installation des d√©pendances manquantes
        contrib/scripts/install_prereq install
        
        # Compilation
        make menuselect.makeopts
        # Activer les modules LDAP
        menuselect/menuselect --enable res_config_ldap menuselect.makeopts
        menuselect/menuselect --enable res_ldap menuselect.makeopts
        
        make -j$(nproc)
        make install
        make samples
        make config
        
        echo "[‚úì] Asterisk compil√© et install√© depuis les sources"
    else
        echo "[-] Impossible de t√©l√©charger Asterisk, essai d'installation minimale..."
        # Installation de paquets alternatifs si disponibles
        apt install -y asterisk-core-sounds-en-gsm asterisk-core-sounds-en-wav || true
    fi
fi

# Installation des d√©pendances LDAP
echo "[+] Installation des outils LDAP..."
apt install -y ldap-utils libldap2-dev

# Installation des sons (noms corrects pour Debian 12)
echo "[+] Installation des codecs et sons..."
apt install -y asterisk-core-sounds-en-gsm asterisk-core-sounds-en-wav asterisk-moh-opsound-gsm asterisk-moh-opsound-wav 2>/dev/null || echo "[!] Certains paquets de sons non disponibles"

# Installation d'outils utiles pour le d√©pannage
echo "[+] Installation d'outils de diagnostic..."
apt install -y tcpdump htop nano net-tools

# Installation du support pour les codecs propri√©taires (optionnel)
echo "[+] Installation du support pour codecs suppl√©mentaires..."
apt install -y asterisk-g729 2>/dev/null || echo "[!] Codec G.729 non disponible (normal)"

# Configurer le firewall UFW si pr√©sent
if command -v ufw &> /dev/null; then
    echo "[+] Configuration du firewall UFW..."
    ufw allow 5060/udp comment "Asterisk SIP"
    ufw allow 5060/tcp comment "Asterisk SIP"
    ufw allow 10000:20000/udp comment "Asterisk RTP"
    echo "[‚úì] R√®gles firewall ajout√©es"
fi

# V√©rifier l'installation
if command -v asterisk &> /dev/null; then
    echo "[‚úì] Asterisk install√© avec succ√®s - Version: $(asterisk -V 2>/dev/null || echo 'Version inconnue')"
elif [ -f /usr/sbin/asterisk ]; then
    echo "[‚úì] Asterisk install√© dans /usr/sbin/"
    ln -sf /usr/sbin/asterisk /usr/local/bin/asterisk 2>/dev/null || true
elif [ -f /usr/local/sbin/asterisk ]; then
    echo "[‚úì] Asterisk install√© dans /usr/local/sbin/"
    ln -sf /usr/local/sbin/asterisk /usr/local/bin/asterisk 2>/dev/null || true
else
    echo "[-] Erreur: Asterisk n'a pas pu √™tre install√©"
    echo "[!] Essayons une installation manuelle simplifi√©e..."
    
    # Installation manuelle alternative
    cd /tmp
    echo "[+] Tentative d'installation depuis Debian Sid..."
    wget -q http://ftp.debian.org/debian/pool/main/a/asterisk/asterisk_20.4.0~dfsg+~cs6.10.40431411-2_amd64.deb 2>/dev/null || true
    
    if [ -f "asterisk_20.4.0~dfsg+~cs6.10.40431411-2_amd64.deb" ]; then
        echo "[+] Installation du paquet .deb t√©l√©charg√©..."
        dpkg -i asterisk_20.4.0~dfsg+~cs6.10.40431411-2_amd64.deb 2>/dev/null || true
        apt-get install -f -y  # Corriger les d√©pendances
    fi
    
    # Derni√®re v√©rification
    if ! command -v asterisk &> /dev/null && ! [ -f /usr/sbin/asterisk ] && ! [ -f /usr/local/sbin/asterisk ]; then
        echo "[-] Installation d'Asterisk √©chou√©e. Veuillez installer manuellement:"
        echo "    1. Compiler depuis les sources : https://www.asterisk.org/downloads/"
        echo "    2. Ou utiliser un d√©p√¥t tiers"
        echo "    3. Ou installer depuis Debian Sid/Testing"
        exit 1
    fi
fi

# Arr√™ter Asterisk s'il est en cours d'ex√©cution
echo "[+] Arr√™t d'Asterisk..."
systemctl stop asterisk 2>/dev/null || true

# Sauvegarder la configuration existante
echo "[+] Sauvegarde de la configuration existante..."
if [ -d /etc/asterisk ]; then
    cp -r /etc/asterisk /etc/asterisk.backup.$(date +%Y%m%d_%H%M%S)
    echo "[‚úì] Configuration sauvegard√©e"
fi

# Cr√©er les r√©pertoires n√©cessaires
echo "[+] Cr√©ation des r√©pertoires..."
mkdir -p /var/lib/asterisk/sounds/custom
mkdir -p /var/log/asterisk
mkdir -p /var/spool/asterisk/voicemail
mkdir -p /var/run/asterisk

# Cr√©er l'utilisateur asterisk s'il n'existe pas
if ! id "asterisk" &>/dev/null; then
    echo "[+] Cr√©ation de l'utilisateur asterisk..."
    useradd -r -d /var/lib/asterisk -s /bin/false asterisk
fi

# D√©finir les permissions
echo "[+] Configuration des permissions..."
chown -R asterisk:asterisk /var/lib/asterisk
chown -R asterisk:asterisk /var/log/asterisk
chown -R asterisk:asterisk /var/spool/asterisk
chown -R asterisk:asterisk /var/run/asterisk
chown -R asterisk:asterisk /etc/asterisk

# Configurer les permissions des fichiers de configuration
chmod 640 /etc/asterisk/*.conf 2>/dev/null || true
chmod 750 /etc/asterisk

echo "[+] Configuration d'Asterisk pour FreeIPA LDAP..."

# 1. Configuration de res_ldap.conf
echo "[+] Configuration de res_ldap.conf..."
cat > /etc/asterisk/res_ldap.conf <<EOF
[_general]
url = ldap://${FREEIPA_SERVER}:389
basedn = ${LDAP_BASE_DN}
user = ${ASTERISK_BIND_DN}
pass = VotreMotDePasseLDAP
version = 3
; Options de connexion
timelimit = 30
sizelimit = 100

[sipusers]
; Configuration pour r√©cup√©rer les utilisateurs SIP depuis FreeIPA
url = ldap://${FREEIPA_SERVER}:389
basedn = cn=users,cn=accounts,${LDAP_BASE_DN}
; Filtre pour ne r√©cup√©rer que les utilisateurs avec extension Asterisk
filter = (&(objectClass=AsteriskAccount)(asteriskExtension=*))

; Mapping des attributs FreeIPA vers Asterisk
; Nom d'utilisateur SIP = extension
name = asteriskExtension
; Mot de passe SIP
secret = asteriskPassword
; Configuration SIP par d√©faut
host = dynamic
type = friend
context = internal
dtmfmode = rfc2833
nat = force_rport,comedia
qualify = yes
canreinvite = no
; Caller ID depuis le nom complet FreeIPA
callerid = cn
; Bo√Æte vocale = extension
mailbox = asteriskExtension
EOF

# 2. Configuration de sip.conf
echo "[+] Configuration de sip.conf..."
cat > /etc/asterisk/sip.conf <<EOF
[general]
; Configuration g√©n√©rale SIP
context = unauthenticated
bindport = 5060
bindaddr = 0.0.0.0
srvlookup = yes
allowguest = no
alwaysauthreject = yes

; Codecs autoris√©s
disallow = all
allow = ulaw
allow = alaw
allow = gsm
allow = g729

; Configuration pour la r√©cup√©ration temps r√©el depuis LDAP
rtcachefriends = yes
rtupdate = yes
rtautoclear = 120
rtsavesysname = yes

; S√©curit√©
allowoverlap = no
matchexterniplocally = yes

; NAT et firewall
nat = force_rport,comedia
externip = VOTRE_IP_PUBLIQUE
localnet = 192.168.200.0/24

; Template par d√©faut pour les utilisateurs LDAP
[ldap-template](!)
type = friend
host = dynamic
context = internal
dtmfmode = rfc2833
nat = force_rport,comedia
qualify = yes
canreinvite = no
insecure = no
directmedia = no
EOF

# 3. Configuration de extconfig.conf pour activer LDAP
echo "[+] Configuration de extconfig.conf..."
cat > /etc/asterisk/extconfig.conf <<EOF
[settings]
; Configuration pour utiliser LDAP comme source de donn√©es
sipusers => ldap,"sipusers"
sippeers => ldap,"sipusers"
EOF

# 4. Configuration du dialplan (extensions.conf)
echo "[+] Configuration du dialplan (extensions.conf)..."
cat > /etc/asterisk/extensions.conf <<EOF
[general]
static = yes
writeprotect = no
clearglobalvars = no

[globals]
; Variables globales

[internal]
; Contexte pour les appels internes entre extensions
; Appel direct vers une extension (1001, 1002, etc.)
exten => _1XXX,1,NoOp(Appel vers l'extension \${EXTEN})
exten => _1XXX,n,Dial(SIP/\${EXTEN},30,tT)
exten => _1XXX,n,GotoIf(\$[\${DIALSTATUS} = BUSY]?busy:unavail)
exten => _1XXX,n(unavail),VoiceMail(\${EXTEN}@default,u)
exten => _1XXX,n,Hangup()
exten => _1XXX,n(busy),VoiceMail(\${EXTEN}@default,b)
exten => _1XXX,n,Hangup()

; Acc√®s √† la messagerie vocale
exten => *97,1,NoOp(Acc√®s messagerie vocale)
exten => *97,n,VoiceMailMain(\${CALLERID(num)}@default)
exten => *97,n,Hangup()

; Test de connectivit√©
exten => 999,1,Answer()
exten => 999,n,Playback(demo-congrats)
exten => 999,n,Hangup()

[unauthenticated]
; Contexte pour les connexions non authentifi√©es
; Rejeter tous les appels non authentifi√©s
exten => _X.,1,NoOp(Appel non authentifi√© refus√©)
exten => _X.,n,Congestion()
exten => _X.,n,Hangup()

[default]
; Contexte par d√©faut - redirection vers internal pour les utilisateurs authentifi√©s
include => internal
EOF

# 5. Configuration de modules.conf
echo "[+] Configuration des modules..."
# Sauvegarder le fichier existant
cp /etc/asterisk/modules.conf /etc/asterisk/modules.conf.bak 2>/dev/null || true

# Cr√©er une configuration modules.conf compl√®te
cat > /etc/asterisk/modules.conf <<EOF
[modules]
autoload=yes

; Modules de base requis
load => res_musiconhold.so
load => app_dial.so
load => app_playback.so
load => app_voicemail.so
load => chan_sip.so

; Modules LDAP requis
load => res_ldap.so
load => res_config_ldap.so

; Modules de codecs
load => codec_ulaw.so
load => codec_alaw.so
load => codec_gsm.so

; Modules d'applications utiles
load => app_echo.so
load => app_milliwatt.so
load => app_congestion.so
load => app_hangup.so
load => app_answer.so

; Modules de fonctions
load => func_callerid.so
load => func_logic.so
load => func_strings.so

; Ne pas charger les modules suivants si pr√©sents
noload => chan_alsa.so
noload => chan_oss.so
noload => chan_console.so
EOF

# 6. Configuration de voicemail.conf
echo "[+] Configuration de la messagerie vocale..."
cat > /etc/asterisk/voicemail.conf <<EOF
[general]
format = wav49|gsm|wav
serveremail = asterisk@tp.local
attach = yes
skipms = 3000
maxsilence = 10
silencethreshold = 128
maxlogins = 3

[default]
; Les bo√Ætes vocales seront cr√©√©es automatiquement
; bas√©es sur les extensions LDAP
EOF

# 7. Configuration de logger.conf pour les logs
echo "[+] Configuration des logs..."
cat > /etc/asterisk/logger.conf <<EOF
[general]
dateformat=%F %T

[logfiles]
console => notice,warning,error,debug,verbose
messages => notice,warning,error
full => notice,warning,error,debug,verbose,dtmf,fax
debug => debug
verbose => verbose
EOF

# 8. Script de test de connectivit√© LDAP
echo "[+] Cr√©ation du script de test LDAP..."
cat > /tmp/test_ldap.sh <<EOF
#!/bin/bash
echo "Test de connectivit√© LDAP vers FreeIPA..."
ldapsearch -x -H ldap://${FREEIPA_SERVER}:389 \\
  -D "${ASTERISK_BIND_DN}" \\
  -w "VotreMotDePasseLDAP" \\
  -b "cn=users,cn=accounts,${LDAP_BASE_DN}" \\
  "(&(objectClass=AsteriskAccount)(asteriskExtension=*))" \\
  uid cn asteriskExtension asteriskPassword

echo ""
echo "V√©rification des utilisateurs Asterisk dans LDAP..."
ldapsearch -x -H ldap://${FREEIPA_SERVER}:389 \\
  -D "${ASTERISK_BIND_DN}" \\
  -w "VotreMotDePasseLDAP" \\
  -b "cn=users,cn=accounts,${LDAP_BASE_DN}" \\
  "(asteriskExtension=*)" dn asteriskExtension
EOF

chmod +x /tmp/test_ldap.sh

# V√©rifier la configuration
echo "[+] V√©rification de la configuration..."

# Test de syntaxe de la configuration
if asterisk -T -C /etc/asterisk/asterisk.conf 2>/dev/null; then
    echo "[‚úì] Configuration Asterisk valide"
else
    echo "[!] Attention: Probl√®mes potentiels dans la configuration"
fi

# Activer et d√©marrer le service
echo "[+] Activation du service Asterisk..."
systemctl enable asterisk
systemctl start asterisk

# Attendre que le service d√©marre
sleep 5

# V√©rifier le statut
if systemctl is-active --quiet asterisk; then
    echo "[‚úì] Asterisk d√©marr√© avec succ√®s"
else
    echo "[-] Probl√®me de d√©marrage d'Asterisk"
    echo "Consultez les logs: journalctl -u asterisk -f"
fi

echo ""
echo "============================================="
echo "Installation et configuration termin√©es !"
echo "============================================="
echo ""
echo "üìã √âTAPES DE FINALISATION :"
echo ""
echo "1Ô∏è‚É£  Configurez le mot de passe LDAP :"
echo "   nano /etc/asterisk/res_ldap.conf"
echo "   (Remplacez 'VotreMotDePasseLDAP' par le vrai mot de passe)"
echo ""
echo "2Ô∏è‚É£  V√©rifiez/ajustez l'IP r√©seau si n√©cessaire :"
echo "   nano /etc/asterisk/sip.conf"
echo "   (V√©rifiez les lignes 'externip' et 'localnet')"
echo ""
echo "3Ô∏è‚É£  Testez la connectivit√© LDAP :"
echo "   /tmp/test_ldap.sh"
echo ""
echo "4Ô∏è‚É£  Red√©marrez Asterisk apr√®s les modifications :"
echo "   systemctl restart asterisk"
echo ""
echo "5Ô∏è‚É£  V√©rifiez que les utilisateurs LDAP sont d√©tect√©s :"
echo "   asterisk -rx 'sip show peers'"
echo ""
echo "üîç V√âRIFICATION ET D√âPANNAGE :"
echo "   ‚Ä¢ Logs en temps r√©el : tail -f /var/log/asterisk/full"
echo "   ‚Ä¢ CLI interactive : asterisk -rvvv"
echo "   ‚Ä¢ Statut du service : systemctl status asterisk"
echo "   ‚Ä¢ Test r√©seau : netstat -tulpn | grep asterisk"
echo ""
echo "üì± CONFIGURATION SOFTPHONE :"
echo "   ‚Ä¢ Serveur SIP : $(hostname -I | awk '{print $1}' | head -1)"
echo "   ‚Ä¢ Port SIP : 5060"
echo "   ‚Ä¢ Utilisateur 1 : 1001 / sipPass123"
echo "   ‚Ä¢ Utilisateur 2 : 1002 / sipPass456"
echo "   ‚Ä¢ Extension de test : 999 (test audio)"
echo "   ‚Ä¢ Messagerie vocale : *97"
echo ""
echo "üöÄ TESTS √Ä EFFECTUER :"
echo "   1. Connecter un softphone avec l'extension 1001"
echo "   2. Connecter un second softphone avec l'extension 1002"
echo "   3. Tester un appel entre les deux extensions"
echo "   4. Composer le 999 pour le test audio"
echo "   5. Tester la messagerie vocale avec *97"
echo ""
echo "üí° SOFTPHONES RECOMMAND√âS :"
echo "   ‚Ä¢ Linphone (multiplateforme)"
echo "   ‚Ä¢ Zoiper (Windows/Mac/Mobile)"
echo "   ‚Ä¢ X-Lite (Windows/Mac)"
echo "   ‚Ä¢ CSipSimple (Android)"