#!/bin/bash
set -e

# Adresse IP du DNS maÃ®tre
DNS_MAITRE="192.168.200.30"

# Liste des zones Ã  configurer en slave, correspondant aux zones master
ZONES=(
  "smarttech.local"
  "tp.local"
  "local"
  "200.168.192.in-addr.arpa"
)

# RÃ©pertoires
BIND_CONF_DIR="/etc/bind"
ZONE_CACHE_DIR="/var/cache/bind"

echo "ðŸ“¦ Mise Ã  jour et installation de bind9 + dnsutils..."
apt update
apt install -y bind9 bind9utils bind9-doc dnsutils

echo "ðŸ§¼ Sauvegarde de la configuration existante (named.conf.local)..."
if [ -f "$BIND_CONF_DIR/named.conf.local" ]; then
  cp "$BIND_CONF_DIR/named.conf.local" "$BIND_CONF_DIR/named.conf.local.bak.$(date +%s)"
fi

echo "ðŸ“ CrÃ©ation de named.conf.local avec les zones esclave (slave)..."
cat > "$BIND_CONF_DIR/named.conf.local" <<EOF
// Configuration des zones DNS secondaires (slaves)
EOF

for zone in "${ZONES[@]}"; do
  cat >> "$BIND_CONF_DIR/named.conf.local" <<EOF
zone "$zone" {
    type slave;
    masters { $DNS_MAITRE; };
    file "$ZONE_CACHE_DIR/db.$zone";
};

EOF
done

echo "ðŸ” VÃ©rification de la configuration BIND..."
named-checkconf

echo "ðŸ”„ RedÃ©marrage du service DNS 'named'..."
if command -v service >/dev/null 2>&1; then
  service named restart || /etc/init.d/named restart
else
  /etc/init.d/named restart
fi

echo "âœ… Configuration DNS secondaire terminÃ©e."
