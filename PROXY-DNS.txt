#!/bin/bash
set -e

echo "ðŸ”§ Installation de dnsmasq..."
apt update
apt install -y dnsmasq

echo "ðŸ—‚ï¸ Sauvegarde de la configuration existante..."
cp /etc/dnsmasq.conf /etc/dnsmasq.conf.bak

echo "âœï¸ Ã‰criture de la nouvelle configuration..."
tee /etc/dnsmasq.conf > /dev/null << 'EOF'
##############################################
# dnsmasq.conf â€“ Proxy DNS (192.168.100.20) #
##############################################

# Interface rÃ©seau utilisÃ©e dans la DMZ
interface=eth0
listen-address=127.0.0.1,192.168.100.20

# Taille du cache DNS
cache-size=1000

# Ne pas utiliser /etc/resolv.conf
no-resolv

# Serveurs DNS internes (primaire + secondaire)
server=/tp.local/192.168.200.30
server=/tp.local/192.168.100.30

server=/smarttech.local/192.168.200.30
server=/smarttech.local/192.168.100.30

server=/local/192.168.200.30
server=/local/192.168.100.30

# Serveurs DNS publics (pour les domaines externes)
server=8.8.8.8
server=1.1.1.1

# EmpÃªche l'Ã©coute sur d'autres interfaces rÃ©seau
bind-interfaces

# Log des requÃªtes DNS (pour dÃ©bogage)
log-queries
log-facility=/var/log/dnsmasq.log
EOF

echo "ðŸš€ RedÃ©marrage du service dnsmasq..."
 service  dnsmasq restart

echo "âœ… Installation et configuration terminÃ©es."
