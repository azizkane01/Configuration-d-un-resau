#!/bin/bash
set -e

# -----------------------------
# VARIABLES Ã€ ADAPTER
# -----------------------------
LDAP_HOSTNAME="ldap.tp.local"                          # Nom ou IP rÃ©soluble du serveur LDAP
LDAP_IP="192.168.200.50"                               # Pour /etc/hosts si pas de DNS
LDAP_BIND_DN="uid=freeradius_admin,ou=freeradius_users,dc=tp,dc=local"
LDAP_BIND_PW="Passer123"                               # Mot de passe du bind DN
BASE_DN="dc=tp,dc=local"                               # Suffixe LDAP
CERT_FILE="/etc/freeradius/3.0/certs/ldap-ca.pem"      # Chemin pour stocker le certificat LDAP/CA extrait
LDAP_CONF="/etc/freeradius/3.0/mods-available/ldap"
CLIENTS_CONF="/etc/freeradius/3.0/clients.conf"
SITE_DEFAULT="/etc/freeradius/3.0/sites-enabled/default"
SITE_INNERTUNNEL="/etc/freeradius/3.0/sites-enabled/inner-tunnel"

echo "[*] VÃ©rification des privilÃ¨ges root..."
if [[ $EUID -ne 0 ]]; then
    echo "âŒ Ce script doit Ãªtre exÃ©cutÃ© en tant que root."
    exit 1
fi

# -----------------------------
# 1. Installation des paquets nÃ©cessaires
# -----------------------------
echo "[*] Installation de FreeRADIUS et utilitaires LDAP..."
apt update -y
apt install -y freeradius freeradius-ldap ldap-utils openssl curl

# -----------------------------
# 2. RÃ©cupÃ©ration du certificat via STARTTLS
# -----------------------------
echo "[*] RÃ©cupÃ©ration du certificat LDAP via STARTTLS sur $LDAP_HOSTNAME:389..."
mkdir -p "$(dirname "$CERT_FILE")"
if echo | openssl s_client -connect "${LDAP_HOSTNAME}:389" -starttls ldap -showcerts 2>/dev/null | \
     awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/' > "$CERT_FILE"; then
    if [[ -s "$CERT_FILE" ]]; then
        chmod 644 "$CERT_FILE"
        echo "âœ… Certificat extrait dans $CERT_FILE"
        echo "   Empreinte SHA256 :"
        openssl x509 -in "$CERT_FILE" -noout -fingerprint -sha256
    else
        echo "âŒ Aucun certificat rÃ©cupÃ©rÃ© (fichier vide). VÃ©rifiez la prise en charge STARTTLS sur le serveur."
        exit 1
    fi
else
    echo "âŒ Ã‰chec de rÃ©cupÃ©ration du certificat via STARTTLS. VÃ©rifiez la connectivitÃ© et la configuration du serveur LDAP."
    exit 1
fi

# -----------------------------
# 3. Mise Ã  jour de /etc/hosts : 192.168.200.50 --> ldap.tp.local
# -----------------------------
echo "[*] VÃ©rification de /etc/hosts pour $LDAP_HOSTNAME..."
HOSTS_PATTERN="^[[:space:]]*${LDAP_IP}[[:space:]]+${LDAP_HOSTNAME}([[:space:]]|\$)"
if ! grep -qE "$HOSTS_PATTERN" /etc/hosts; then
    echo "${LDAP_IP}    ${LDAP_HOSTNAME}" >> /etc/hosts
    echo "âœ… EntrÃ©e ajoutÃ©e dans /etc/hosts : ${LDAP_IP}    ${LDAP_HOSTNAME}"
else
    echo "â„¹ï¸ Lâ€™entrÃ©e ${LDAP_HOSTNAME} existe dÃ©jÃ  dans /etc/hosts"
fi

# -----------------------------
# 4. Configuration du module LDAP (mods-available/ldap)
# -----------------------------
echo "[*] Ã‰criture de la configuration LDAP dans $LDAP_CONF..."
cat > "$LDAP_CONF" <<EOF
ldap {
    server = "$LDAP_HOSTNAME"
    port = 389
    identity = "$LDAP_BIND_DN"
    password = "$LDAP_BIND_PW"
    base_dn = "$BASE_DN"

    user {
        base_dn = "$BASE_DN"
        filter = "(uid=%{%{Stripped-User-Name}:-%{User-Name}})"
        scope = "sub"
        access_positive = yes
    }

    authenticate {
        auth_type = bind
    }

    tls {
        start_tls = yes
        ca_file = "$CERT_FILE"
        require_cert = "demand"
    }

    timeout = 5
    timelimit = 3
    net_timeout = 3
}
EOF
echo "âœ… Module LDAP Ã©crit dans $LDAP_CONF (STARTTLS, require_cert=\"demand\")."

# -----------------------------
# 6. Activation du module LDAP
# -----------------------------
echo "[*] Activation du module LDAP..."
ln -sf ../mods-available/ldap /etc/freeradius/3.0/mods-enabled/ldap
echo "âœ… Lien symbolique crÃ©Ã© pour ldap"

# -----------------------------
# 7. Mise Ã  jour des sites-enabled
# -----------------------------
echo "[*] Mise Ã  jour de sites-enabled pour inclure LDAP..."

insert_unlang_blocks() {
    local site_file="$1"
    if [[ ! -f "$site_file" ]]; then
        echo "â„¹ï¸ Fichier $site_file non trouvÃ©, on skip."
        return
    fi
    echo "[*] Traitement de $site_file..."

    # InsÃ©rer le module ldap dans authorize s'il n'existe pas
    if ! grep -q "^[[:space:]]*ldap" "$site_file"; then
        sed -i "/^authorize[[:space:]]*{/a\    ldap" "$site_file"
        echo "  - 'ldap' ajoutÃ© dans authorize{}"
    else
        echo "  - 'ldap' dÃ©jÃ  prÃ©sent dans authorize{}"
    fi

    if ! grep -q "if (!control.Auth-Type)" "$site_file"; then
        sed -i "/^authorize[[:space:]]*{/a\\
    if (!control:Auth-Type) {\\
        update control {\\
            Auth-Type := LDAP\\
        }\\
    }" "$site_file"
        echo "  - Bloc inconditionnel Auth-Type := LDAP ajoutÃ© dans authorize{}"
    else
        echo "  - Bloc inconditionnel Auth-Type dÃ©jÃ  prÃ©sent dans authorize{}"
    fi

    # InsÃ©rer le bloc Auth-Type LDAP dans authenticate si absent
    if ! grep -q "Auth-Type LDAP" "$site_file"; then
        sed -i "/^authenticate[[:space:]]*{/a\\
    Auth-Type LDAP {\\
        ldap\\
    }" "$site_file"
        echo "  - Bloc Auth-Type LDAP ajoutÃ© dans authenticate{}"
    else
        echo "  - Bloc Auth-Type LDAP dÃ©jÃ  prÃ©sent dans authenticate{}"
    fi
}

insert_unlang_blocks "$SITE_DEFAULT"
insert_unlang_blocks "$SITE_INNERTUNNEL"

# -----------------------------
# 8. RedÃ©marrage et activation du service
# -----------------------------
echo "[*] RedÃ©marrage du service FreeRADIUS..."
if systemctl restart freeradius; then
    echo "âœ… FreeRADIUS redÃ©marrÃ©"
    systemctl enable freeradius
else
    echo "âŒ Ã‰chec du redÃ©marrage. Lancez 'freeradius -X' pour debug."
    exit 1
fi

# -----------------------------
# 9. Instructions de test
# -----------------------------
echo -e "\nðŸŽ‰ Script terminÃ©. FreeRADIUS configurÃ© pour LDAP+STARTTLS."
echo "âž¡ï¸ Tester en mode debug : freeradius -X"
echo "âž¡ï¸ Tester le bind LDAP avec STARTTLS :"
echo "     ldapwhoami -H ldap://$LDAP_HOSTNAME -ZZ -D \"$LDAP_BIND_DN\" -w \"$LDAP_BIND_PW\""
echo "âž¡ï¸ Tester la recherche dâ€™un utilisateur :"
echo "     ldapsearch -H ldap://$LDAP_HOSTNAME -ZZ -x -D \"$LDAP_BIND_DN\" -w \"$LDAP_BIND_PW\" -b \"$BASE_DN\" \"(uid=testuser)\""
echo "âž¡ï¸ Tester via RADIUS :"
echo "     radtest <utilisateur> <mot_de_passe> localhost 0 secretpartage"

# Fin du script
